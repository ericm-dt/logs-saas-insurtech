paths:
  /api/policies:
    get:
      tags:
        - Policies
      summary: Get all policies
      description: Retrieve a list of all insurance policies with optional filters
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [ACTIVE, INACTIVE, PENDING, CANCELLED, EXPIRED]
          description: Filter by policy status
        - name: type
          in: query
          schema:
            type: string
            enum: [AUTO, HOME, LIFE, HEALTH, BUSINESS]
          description: Filter by policy type
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user ID
        - name: startDateFrom
          in: query
          schema:
            type: string
            format: date
          description: Filter policies starting after this date
        - name: startDateTo
          in: query
          schema:
            type: string
            format: date
          description: Filter policies starting before this date
        - name: endDateFrom
          in: query
          schema:
            type: string
            format: date
          description: Filter policies ending after this date
        - name: endDateTo
          in: query
          schema:
            type: string
            format: date
          description: Filter policies ending before this date
        - name: minPremium
          in: query
          schema:
            type: number
          description: Minimum premium amount
        - name: maxPremium
          in: query
          schema:
            type: number
          description: Maximum premium amount
        - name: search
          in: query
          schema:
            type: string
          description: Search by policy number (case-insensitive)
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Number of results per page
      responses:
        '200':
          description: List of policies retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Policy'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                        example: 1
                      limit:
                        type: integer
                        example: 50
                      total:
                        type: integer
                        example: 250
                      pages:
                        type: integer
                        example: 5
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    post:
      tags:
        - Policies
      summary: Create a new policy
      description: Create a new insurance policy for a customer
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - policyNumber
                - type
                - startDate
                - endDate
                - premium
                - coverageAmount
              properties:
                policyNumber:
                  type: string
                  example: POL-2024-001234
                  description: Unique policy identifier
                type:
                  type: string
                  enum: [AUTO, HOME, LIFE, HEALTH, BUSINESS]
                  example: AUTO
                startDate:
                  type: string
                  format: date-time
                  example: 2024-01-01T00:00:00Z
                endDate:
                  type: string
                  format: date-time
                  example: 2025-01-01T00:00:00Z
                premium:
                  type: number
                  format: decimal
                  example: 1200.50
                coverageAmount:
                  type: number
                  format: decimal
                  example: 50000.00
                status:
                  type: string
                  enum: [ACTIVE, PENDING, CANCELLED, EXPIRED]
                  default: PENDING
                  description: Policy status (defaults to PENDING)
      responses:
        '201':
          description: Policy created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Policy'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/policies/{id}:
    get:
      tags:
        - Policies
      summary: Get policy by ID
      description: Retrieve a specific policy's information
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Policy UUID
      responses:
        '200':
          description: Policy retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Policy'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    put:
      tags:
        - Policies
      summary: Update policy
      description: Update policy information
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Policy UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [ACTIVE, INACTIVE, PENDING, CANCELLED, EXPIRED]
                premium:
                  type: number
                  format: decimal
                coverageAmount:
                  type: number
                  format: decimal
                endDate:
                  type: string
                  format: date
                statusChangeReason:
                  type: string
                  description: Optional reason for status change (tracked in history)
                  example: Customer requested policy cancellation
      responses:
        '200':
          description: Policy updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Policy'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    
    delete:
      tags:
        - Policies
      summary: Delete policy
      description: Remove a policy from the system (Admin only)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Policy UUID
      responses:
        '200':
          description: Policy deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Policy deleted successfully
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /api/policies/{id}/history:
    get:
      tags:
        - Policies
      summary: Get policy status history
      description: Retrieve the complete history of status changes for a policy
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Policy UUID
      responses:
        '200':
          description: Policy status history retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PolicyStatusHistory'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'


  /api/policies/{id}/file-claim:
    post:
      tags:
        - Policies
        - Workflows
      summary: File claim from policy
      description: |
        File an insurance claim against an active policy. This is a workflow endpoint that:
        - Validates policy exists and is ACTIVE
        - Auto-fills policyId and userId from policy
        - Creates claim in SUBMITTED status
        - Cross-service call to claims-service
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Policy UUID to file claim against
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - incidentDate
                - description
                - claimAmount
              properties:
                incidentDate:
                  type: string
                  format: date
                  example: '2025-11-20'
                  description: Date the incident occurred
                description:
                  type: string
                  example: Rear-end collision at stoplight
                  description: Detailed description of the claim
                claimAmount:
                  type: number
                  format: decimal
                  example: 3500.00
                  description: Requested claim amount
      responses:
        '201':
          description: Claim filed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    description: Newly created claim
                  message:
                    type: string
                    example: Claim filed successfully
        '400':
          description: Policy is not ACTIVE or validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Claims can only be filed on ACTIVE policies
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/policies/my/policies:
    get:
      tags:
        - Policies
        - User-Scoped
      summary: Get my policies
      description: |
        Retrieve policies for the authenticated user only. 
        Automatically filters by userId from JWT token.
        Supports same filtering/pagination as GET /policies but scoped to current user.
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [ACTIVE, INACTIVE, PENDING, CANCELLED, EXPIRED]
          description: Filter by policy status
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: Page number for pagination
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Number of results per page
      responses:
        '200':
          description: User policies retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Policy'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                        example: 1
                      limit:
                        type: integer
                        example: 50
                      total:
                        type: integer
                        example: 12
                      pages:
                        type: integer
                        example: 1
        '401':
          $ref: '#/components/responses/UnauthorizedError'
components:
  responses:
    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: Unauthorized
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: Validation failed
              errors:
                type: array
                items:
                  type: object
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: Not found
    ForbiddenError:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: Forbidden
  schemas:
    Policy:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        policyNumber:
          type: string
        type:
          type: string
          enum: [AUTO, HOME, LIFE, HEALTH, BUSINESS]
        status:
          type: string
          enum: [ACTIVE, INACTIVE, PENDING, CANCELLED, EXPIRED]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        premium:
          type: number
          format: decimal
        coverageAmount:
          type: number
          format: decimal
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    PolicyStatusHistory:
      type: object
      properties:
        id:
          type: string
          format: uuid
        policyId:
          type: string
          format: uuid
        organizationId:
          type: string
          format: uuid
        oldStatus:
          type: string
          enum: [ACTIVE, INACTIVE, PENDING, CANCELLED, EXPIRED]
          nullable: true
        newStatus:
          type: string
          enum: [ACTIVE, INACTIVE, PENDING, CANCELLED, EXPIRED]
        changedBy:
          type: string
          format: uuid
        changedAt:
          type: string
          format: date-time
        reason:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true

