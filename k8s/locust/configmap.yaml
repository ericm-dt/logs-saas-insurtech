apiVersion: v1
kind: ConfigMap
metadata:
  name: locust-scripts
  namespace: load-testing
data:
  locustfile.py: |
    from locust import HttpUser, task, between
    import json
    import random

    class DynaClaimzUser(HttpUser):
        wait_time = between(1, 3)
        
        def on_start(self):
            """Login and get auth token"""
            # Register or login
            response = self.client.post("/api/v1/auth/login", json={
                "email": f"user{random.randint(1, 100)}@example.com",
                "password": "Password123!"
            }, catch_response=True)
            
            if response.status_code == 200:
                data = response.json()
                self.token = data.get("data", {}).get("token", "")
                self.headers = {"Authorization": f"Bearer {self.token}"}
                response.success()
            else:
                # Try to register if login fails
                response = self.client.post("/api/v1/auth/register", json={
                    "email": f"user{random.randint(1, 100)}@example.com",
                    "password": "Password123!",
                    "firstName": "Test",
                    "lastName": "User",
                    "organizationName": f"Test Org {random.randint(1, 50)}"
                })
                if response.status_code == 201:
                    data = response.json()
                    self.token = data.get("data", {}).get("token", "")
                    self.headers = {"Authorization": f"Bearer {self.token}"}
        
        @task(3)
        def get_policies(self):
            """Get policies list"""
            if hasattr(self, 'headers'):
                self.client.get("/api/v1/policies", headers=self.headers)
        
        @task(2)
        def create_policy(self):
            """Create a new policy"""
            if hasattr(self, 'headers'):
                self.client.post("/api/v1/policies", headers=self.headers, json={
                    "policyNumber": f"POL-{random.randint(10000, 99999)}",
                    "type": random.choice(["auto", "home", "life", "health", "business"]),
                    "status": "active",
                    "premium": random.uniform(100, 5000),
                    "coverageAmount": random.uniform(10000, 1000000),
                    "startDate": "2025-01-01T00:00:00.000Z",
                    "endDate": "2026-01-01T00:00:00.000Z",
                    "customerId": f"customer-{random.randint(1, 100)}"
                })
        
        @task(2)
        def get_claims(self):
            """Get claims list"""
            if hasattr(self, 'headers'):
                self.client.get("/api/v1/claims", headers=self.headers)
        
        @task(1)
        def create_claim(self):
            """Create a new claim"""
            if hasattr(self, 'headers'):
                self.client.post("/api/v1/claims", headers=self.headers, json={
                    "claimNumber": f"CLM-{random.randint(10000, 99999)}",
                    "policyId": f"policy-{random.randint(1, 100)}",
                    "type": random.choice(["accident", "theft", "damage", "medical", "liability"]),
                    "status": "submitted",
                    "amount": random.uniform(500, 50000),
                    "description": "Test claim from load testing",
                    "incidentDate": "2025-12-01T00:00:00.000Z"
                })
        
        @task(1)
        def get_quotes(self):
            """Get quotes list"""
            if hasattr(self, 'headers'):
                self.client.get("/api/v1/quotes", headers=self.headers)
        
        @task(1)
        def health_check(self):
            """Health check endpoint"""
            self.client.get("/health")
